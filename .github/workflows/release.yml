name: Release

on:
    push:
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+"
            - "v[0-9]+.[0-9]+.[0-9]+-*" # Pre-releases like v1.0.0-beta.1

env:
    CARGO_TERM_COLOR: always

permissions:
    contents: write

jobs:
    # Validate the release
    validate:
        name: Validate Release
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            prerelease: ${{ steps.version.outputs.prerelease }}
        steps:
            - uses: actions/checkout@v4

            - name: Extract version info
              id: version
              env:
                  REF_NAME: ${{ github.ref_name }}
              run: |
                  VERSION="${REF_NAME#v}"
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"

                  if [[ "$VERSION" == *"-"* ]]; then
                    echo "prerelease=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "prerelease=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Verify Cargo.toml version matches tag
              env:
                  EXPECTED_VERSION: ${{ steps.version.outputs.version }}
              run: |
                  CARGO_VERSION=$(grep -m1 '^version' Cargo.toml | cut -d'"' -f2)
                  # For prereleases, only check the base version
                  EXPECTED_BASE="${EXPECTED_VERSION%%-*}"
                  if [[ "$CARGO_VERSION" != "$EXPECTED_BASE" ]] && [[ "$CARGO_VERSION" != "$EXPECTED_VERSION" ]]; then
                    echo "Version mismatch: Cargo.toml has $CARGO_VERSION but tag is $EXPECTED_VERSION"
                    exit 1
                  fi
                  echo "Version verified: $CARGO_VERSION"

    # Build release binaries for each platform
    build:
        name: Build (${{ matrix.target }})
        needs: validate
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Linux
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      archive: tar.gz
                    - target: x86_64-unknown-linux-musl
                      os: ubuntu-latest
                      archive: tar.gz
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-latest
                      archive: tar.gz
                    # macOS
                    - target: x86_64-apple-darwin
                      os: macos-latest
                      archive: tar.gz
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      archive: tar.gz
                    # Windows
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      archive: zip

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install cross-compilation tools (Linux)
              if: matrix.os == 'ubuntu-latest' && matrix.target != 'x86_64-unknown-linux-gnu'
              run: |
                  sudo apt-get update
                  if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]]; then
                    sudo apt-get install -y musl-tools
                  elif [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
                    sudo apt-get install -y gcc-aarch64-linux-gnu
                  fi

            - name: Build release binary
              run: cargo build --release --target ${{ matrix.target }} --all-features

            - name: Package binary (Unix)
              if: matrix.os != 'windows-latest'
              env:
                  VERSION: ${{ needs.validate.outputs.version }}
                  TARGET: ${{ matrix.target }}
              run: |
                  BINARY_NAME="ruley"
                  ARCHIVE_NAME="ruley-v${VERSION}-${TARGET}"

                  mkdir -p "dist/${ARCHIVE_NAME}"
                  cp "target/${TARGET}/release/${BINARY_NAME}" "dist/${ARCHIVE_NAME}/"
                  cp README.md LICENSE "dist/${ARCHIVE_NAME}/" 2>/dev/null || true

                  cd dist
                  tar -czvf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
                  shasum -a 256 "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

            - name: Package binary (Windows)
              if: matrix.os == 'windows-latest'
              env:
                  VERSION: ${{ needs.validate.outputs.version }}
                  TARGET: ${{ matrix.target }}
              shell: pwsh
              run: |
                  $BINARY_NAME = "ruley.exe"
                  $ARCHIVE_NAME = "ruley-v$env:VERSION-$env:TARGET"

                  New-Item -ItemType Directory -Force -Path "dist/$ARCHIVE_NAME"
                  Copy-Item "target/$env:TARGET/release/$BINARY_NAME" "dist/$ARCHIVE_NAME/"
                  Copy-Item README.md, LICENSE "dist/$ARCHIVE_NAME/" -ErrorAction SilentlyContinue

                  Compress-Archive -Path "dist/$ARCHIVE_NAME" -DestinationPath "dist/$ARCHIVE_NAME.zip"
                  Get-FileHash "dist/$ARCHIVE_NAME.zip" -Algorithm SHA256 | ForEach-Object { "$($_.Hash.ToLower())  $ARCHIVE_NAME.zip" } | Out-File "dist/$ARCHIVE_NAME.zip.sha256" -Encoding ASCII

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: release-${{ matrix.target }}
                  path: dist/*
                  retention-days: 1

    # Generate changelog
    changelog:
        name: Generate Changelog
        runs-on: ubuntu-latest
        outputs:
            changelog: ${{ steps.read.outputs.changelog }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate changelog
              id: changelog
              uses: orhun/git-cliff-action@v3
              with:
                  config: cliff.toml
                  args: --latest --strip header
              env:
                  OUTPUT: CHANGELOG.md

            - name: Read changelog
              id: read
              run: |
                  CHANGELOG=$(cat CHANGELOG.md)
                  echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
                  echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
                  echo "EOF" >> "$GITHUB_OUTPUT"

    # Create GitHub release
    release:
        name: Create Release
        needs: [validate, build, changelog]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  pattern: release-*

            - name: Prepare release files
              run: |
                  mkdir -p release
                  find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} release/ \;
                  ls -la release/

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  name: ruley v${{ needs.validate.outputs.version }}
                  body: ${{ needs.changelog.outputs.changelog }}
                  prerelease: ${{ needs.validate.outputs.prerelease == 'true' }}
                  files: release/*
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Publish to crates.io (only for non-prereleases)
    publish:
        name: Publish to crates.io
        needs: [validate, release]
        runs-on: ubuntu-latest
        if: needs.validate.outputs.prerelease == 'false'
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Publish to crates.io
              run: cargo publish --all-features
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
