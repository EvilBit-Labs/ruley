name: CI

on:
    push:
        branches: [main, develop, "feature/**"]
    pull_request:
        branches: [main, develop]

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: "-Dwarnings"

# Cancel in-progress runs for the same branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Code quality checks (fast feedback)
    quality:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Check formatting
              run: cargo fmt -- --check

            - name: Run clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

    # Build and test matrix
    test:
        name: Test (${{ matrix.os }})
        needs: quality
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Build
              run: cargo build --all-features

            - name: Run tests
              run: cargo test --all-features

    # Feature matrix testing (only on Linux for speed)
    features:
        name: Features
        runs-on: ubuntu-latest
        needs: quality
        strategy:
            matrix:
                features:
                    - "" # Default features
                    - "--no-default-features"
                    - "--all-features"
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Check feature combination
              run: cargo check ${{ matrix.features }}

    # MSRV (Minimum Supported Rust Version) check
    msrv:
        name: MSRV (1.85)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust 1.85
              uses: dtolnay/rust-toolchain@1.85.0

            - name: Check MSRV
              run: cargo check --all-features

    # Summary job for branch protection
    ci-success:
        name: CI Success
        runs-on: ubuntu-latest
        needs: [quality, test, features, msrv]
        if: always()
        steps:
            - name: Check all jobs passed
              run: |
                  if [[ "${{ needs.quality.result }}" != "success" ]] ||
                     [[ "${{ needs.test.result }}" != "success" ]] ||
                     [[ "${{ needs.features.result }}" != "success" ]] ||
                     [[ "${{ needs.msrv.result }}" != "success" ]]; then
                    echo "One or more jobs failed"
                    exit 1
                  fi
                  echo "All CI jobs passed!"
