name: CI

on:
    push:
        branches: [main, develop, "feature/**"]
    pull_request:
        branches: [main, develop]

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: "-Dwarnings"

# Cancel in-progress runs for the same branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Code quality checks (fast feedback)
    quality:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Check formatting
              run: cargo fmt -- --check

            - name: Run clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Check for typos
              uses: crate-ci/typos@master

    # Security audit
    security:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Install cargo-audit
              run: cargo install cargo-audit

            - name: Run security audit
              run: cargo audit

    # Build and test matrix
    test:
        name: Test (${{ matrix.os }} / Rust ${{ matrix.rust }})
        needs: quality
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                rust: [stable, beta]
                exclude:
                    # Reduce CI time by only testing beta on Linux
                    - os: macos-latest
                      rust: beta
                    - os: windows-latest
                      rust: beta

        steps:
            - uses: actions/checkout@v6

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              if: matrix.rust == 'stable'

            - name: Install Rust toolchain (beta)
              uses: dtolnay/rust-toolchain@beta
              if: matrix.rust == 'beta'

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.rust }}-cargo-

            - name: Build
              run: cargo build --all-features

            - name: Run tests
              run: cargo test --all-features

            - name: Build release
              if: matrix.rust == 'stable'
              run: cargo build --release --all-features

    # Documentation build
    docs:
        name: Documentation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Build documentation
              run: cargo doc --no-deps --all-features
              env:
                  RUSTDOCFLAGS: "-Dwarnings"

    # Feature matrix testing
    features:
        name: Feature Combinations
        runs-on: ubuntu-latest
        needs: quality
        strategy:
            matrix:
                features:
                    - "" # Default features
                    - "--no-default-features"
                    - "--all-features"
                    - "--features anthropic"
                    - "--features openai"
                    - "--features compression-all"
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-features-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-features-

            - name: Check feature combination
              run: cargo check ${{ matrix.features }}

    # MSRV (Minimum Supported Rust Version) check
    msrv:
        name: MSRV Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            # Rust 2024 edition requires Rust 1.85+
            - name: Install Rust 1.85
              uses: dtolnay/rust-toolchain@1.85.0

            - name: Check MSRV
              run: cargo check --all-features

    # Summary job for branch protection
    ci-success:
        name: CI Success
        runs-on: ubuntu-latest
        needs: [quality, security, test, docs, features, msrv]
        if: always()
        steps:
            - name: Check all jobs passed
              env:
                  QUALITY_RESULT: ${{ needs.quality.result }}
                  SECURITY_RESULT: ${{ needs.security.result }}
                  TEST_RESULT: ${{ needs.test.result }}
                  DOCS_RESULT: ${{ needs.docs.result }}
                  FEATURES_RESULT: ${{ needs.features.result }}
                  MSRV_RESULT: ${{ needs.msrv.result }}
              run: |
                  if [[ "$QUALITY_RESULT" != "success" ]] ||
                     [[ "$SECURITY_RESULT" != "success" ]] ||
                     [[ "$TEST_RESULT" != "success" ]] ||
                     [[ "$DOCS_RESULT" != "success" ]] ||
                     [[ "$FEATURES_RESULT" != "success" ]] ||
                     [[ "$MSRV_RESULT" != "success" ]]; then
                    echo "One or more jobs failed"
                    exit 1
                  fi
                  echo "All CI jobs passed!"
